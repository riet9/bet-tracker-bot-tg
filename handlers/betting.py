from telegram import Update
from telegram.ext import ContextTypes
import datetime
from utils.storage import get_user, save_data, LATVIA_TZ

# /bet (–Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞)
async def bet(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["bet_step"] = "match"
    await update.message.reply_text("–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç—á–∞ (–ø—Ä–∏–º–µ—Ä: NaVi vs G2)")

# /cancel
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if "bet_step" in context.user_data:
        context.user_data.clear()
        await update.message.reply_text("‚ùå –í–≤–æ–¥ —Å—Ç–∞–≤–∫–∏ –æ—Ç–º–µ–Ω—ë–Ω.")
    else:
        await update.message.reply_text("‚ÑπÔ∏è –°–µ–π—á–∞—Å —Ç—ã –Ω–µ –≤–≤–æ–¥–∏—à—å —Å—Ç–∞–≤–∫—É.")

# –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫
async def pending(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    user = get_user(chat_id)

    pending_bets = [b for b in user["bets"] if b["status"] == "pending"]
    if not pending_bets:
        await update.message.reply_text("‚úÖ –í—Å–µ —Å—Ç–∞–≤–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!")
        return

    msg = "üìã <b>–¢–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏:</b>\n\n"
    for i, b in enumerate(pending_bets, 1):
        dt = datetime.datetime.fromisoformat(b["time"]) if isinstance(b["time"], str) else b["time"]
        msg += f"{i}. {b['match']} ‚Äî {b['amount']}‚Ç¨ @ {b['coeff']} ({dt.strftime('%d.%m %H:%M')})\n"

    await update.message.reply_text(msg, parse_mode="HTML")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —à–∞–≥–æ–≤ –ø—Ä–∏ /bet
async def bet_step_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    from handlers.today import process_today_lines

    if context.user_data.get("awaiting_today_input"):
        context.user_data.pop("awaiting_today_input")
        lines = update.message.text.splitlines()
        if len(lines) < 2:
            await update.message.reply_text("‚ö†Ô∏è –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏: —Å—Ç–∞–≤–∫–∞ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–µ.")
            return
        await process_today_lines(update, context, lines)
        return

    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ (match -> platform -> amount -> coeff) –º–æ–∂–Ω–æ –¥–æ–ø–∏—Å–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

# /delete –∏ /undelete –≤—ã–Ω–µ—Å–µ–º –≤ buttons.py
